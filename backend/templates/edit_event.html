<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Event</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .edit-event-glass-container {
    background: linear-gradient(to bottom, #007bff, #ffffff);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
.form-label,
h1, h2, h3, h4, h5, h6,
label {
    color: #007bff;
}
input::placeholder, textarea::placeholder {
    color: #007bff;
    opacity: 0.8;
}
        .edit-event-gradient-bar {
            background: linear-gradient(to right, #007bff, #ffffff);
            height: 5px;
            margin-bottom: 20px;
        }
        .form-control, .form-select {
            background-color: #fff;
            border: 1px solid #007bff;
            color: #222;
        }
        .form-control:focus, .form-select:focus {
            border-color: #fff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
        }
        .btn-warning, .btn-secondary, .btn-info, .btn-success {
    background-color: #007bff;
    border-color: #007bff;
    color: #fff;
}
        .alert-success {
            background-color: #fff;
            border-color: #fff;
            color: #fff;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #f5fafd 0%, #dbeafe 100%);">
{% include 'navbar.html' %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div class="app-card col-12 col-md-6 mx-auto p-4" style="max-width: 480px;">
    <div class="edit-event-gradient-bar"></div>
    <h1 class="mb-4 text-primary text-center">Edit Event</h1>
{% if creator_email %}
  <div class="alert alert-info text-center mb-3" style="font-size:1.08rem;">
    <strong>Event created by:</strong> {{ creator_email }}
  </div>
{% endif %}
    {% set editing_blocked = (event.status == 'Completed') or (event.status == 'In Progress' and event.date ~ ' ' ~ event.time <= now.strftime('%Y-%m-%d %H:%M')) %}
    {% if editing_blocked %}
    <div class="alert alert-warning text-center">Editing is not allowed for this event (status: {{ event.status }}).</div>
    {% endif %}
    <form method="post" {% if editing_blocked %}onsubmit="return false;"{% endif %}>
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control form-control-sm" name="title" value="{{ event['title'] }}" required {% if editing_blocked %}disabled{% endif %}>
        </div>
        <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control form-control-sm" name="date" value="{{ event['date'] }}" required {% if editing_blocked %}disabled{% endif %} min="{{ now.strftime('%Y-%m-%d') }}">
        </div>
        <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="time" class="form-control form-control-sm" name="time" value="{{ event['time'] }}" required {% if editing_blocked %}disabled{% endif %}>
        </div>
        <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" class="form-control form-control-sm" name="location" value="{{ event['location'] }}" required {% if editing_blocked %}disabled{% endif %}>
        </div>
        <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select form-select-sm" name="status" required {% if editing_blocked %}disabled{% endif %}>
                <option {% if event['status']=='Upcoming' %}selected{% endif %}>Upcoming</option>
                <option {% if event['status']=='In Progress' %}selected{% endif %}>In Progress</option>
                <option {% if event['status']=='Completed' %}selected{% endif %}>Completed</option>
                <option {% if event['status']=='Cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control form-control-sm" name="description" rows="3" {% if editing_blocked %}disabled{% endif %}>{{ event.description }}</textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Attendance</label>
            <input type="number" class="form-control form-control-sm" name="attendance" min="0" value="{{ event.attendance }}" required {% if editing_blocked %}disabled{% endif %}>
        </div>
        <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
  <button type="submit" class="btn btn-warning" {% if editing_blocked %}disabled{% endif %}>Save Changes</button>
  <a href="/" class="btn btn-secondary">Cancel</a>
  <a href="/predict_attendance/{{ event.id }}" class="btn btn-info" data-bs-toggle="tooltip" title="Predict attendance using AI"><i class="bi bi-graph-up"></i> Predict Attendance</a>
  <a href="/face_checkin/{{ event.id }}" class="btn btn-success" data-bs-toggle="tooltip" title="Face check-in for event"><i class="bi bi-person-bounding-box"></i> Face Check-In</a>
</div>
{% if current_user.is_authenticated and current_user.is_admin and event.status == 'Pending Approval' %}
  <div class="alert alert-info text-center mt-4 mb-2">
    <strong>This event is pending approval.</strong>
    <form method="post" style="display:inline;">
      <button type="submit" name="approve_event" value="1" class="btn btn-success ms-2">Approve Event</button>
    </form>
  </div>
{% endif %}
    </form>
    {% if prediction is not none %}
    <div class="alert alert-success mt-3">
        <strong>Predicted Attendance:</strong> {{ prediction }}
    </div>
    {% endif %}
<h2 class="mt-4 text-primary text-center">Attendees</h2>
<table class="table table-bordered table-striped">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Role</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for attendee in attendees %}
    <tr>
      <td>{{ attendee.name }}</td>
      <td>{{ attendee.email }}</td>
      <td>{{ attendee.role }}</td>
      <td>{{ attendee.status }}</td>
      <td>
        <!-- Edit Button triggers a collapsible edit form -->
        <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse"
                data-bs-target="#editAttendee{{ attendee.id }}" aria-expanded="false"
                aria-controls="editAttendee{{ attendee.id }}">
          Edit
        </button>
        <form action="{{ url_for('delete_attendee', event_id=event.id, attendee_id=attendee.id) }}"
              method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this attendee?');">Delete</button>
        </form>
        <div class="collapse mt-2" id="editAttendee{{ attendee.id }}">
          <form action="{{ url_for('edit_attendee', event_id=event.id, attendee_id=attendee.id) }}"
                method="post" class="row g-2 align-items-end">
            <div class="col">
              <input type="text" name="edit_name" class="form-control" value="{{ attendee.name }}" required>
            </div>
            <div class="col">
              <input type="email" name="edit_email" class="form-control" value="{{ attendee.email }}" required>
            </div>
            <div class="col">
              <input type="text" name="edit_role" class="form-control" value="{{ attendee.role }}" required>
            </div>
            <div class="col">
              <button type="submit" class="btn btn-success btn-sm">Save</button>
            </div>
          </form>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- Add Attendee Form -->
<form action="{{ url_for('add_attendee', event_id=event.id) }}" method="post" class="row g-2 align-items-end mb-4">
  <div class="col">
    <input type="text" name="name" class="form-control" placeholder="Name" required>
  </div>
  <div class="col">
    <input type="email" name="email" class="form-control" placeholder="Email" required>
  </div>
  <div class="col">
    <input type="text" name="role" class="form-control" placeholder="Role" value="attendee" required>
  </div>
  <div class="col">
    <button type="submit" class="btn btn-success">Add Attendee</button>
  </div>
</form>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
</body>
</html>
